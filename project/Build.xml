<?xml version="1.0" encoding="utf-8"?>
<xml>

  <!-- Variables and compile flags. -->
  <set name="HXCPP_CPP11" value="1" />
  <set name="OUTPUT_DIR" value="../ndll" unless="OUTPUT_DIR" />
  <set name="DEBUGEXTRA" value="-debug" if="fulldebug" />
  <set name="LIBSUFFIX" value="${HX_TARGET_SUFFIX}" if="HX_TARGET_SUFFIX" />
  <set name="LIBSUFFIX" value="${LIBEXTRA}" unless="LIBSUFFIX" />

  <set name="ndll-tool" value="dll" unless="iphone"/>
  <set name="ndll-tool" value="static" if="iphone"/>

  <set name="LIBFFMPEG_SRC" value="../lib.src/ffmpeg" />
  <set name="LIBFFMPEG_BUILD" value="../lib.build/Windows" />

  <!-- Include HXCPP common build flags. -->
  <include name="${HXCPP}/build-tool/BuildCommon.xml" />

  <echo value="Building extension-ffmpeg..." />

  <!-- extension-ffmpeg's CFFI interface code -->
  <files id="core">
    <!-- Add headers to search path. -->
    <compilerflag value="-Iinclude" />
    <compilerflag value="-I${LIBFFMPEG_SRC}" />

    <compilerflag value="-D_ISOC99_SOURCE" />
    <compilerflag value="-D_FILE_OFFSET_BITS=64" />
    <compilerflag value="-D_LARGEFILE_SOURCE" />
    <compilerflag value="-DPIC" />
    <compilerflag value="-DZLIB_CONST" />
    <compilerflag value="-DHAVE_AV_CONFIG_H" />
    <compilerflag value="-D_GNU_SOURCE=1" />
    <compilerflag value="-D_THREAD_SAFE" />
    <compilerflag value="-Dinline=__inline" if="windows" />

    <!-- Dependencies of CFFI. -->
    <depend name="${HXCPP}/include/hx/Macros.h" />
    <depend name="${HXCPP}/include/hx/CFFI.h" />

    <!--
      The CFFI interface source.
      Split into multiple files for organizational purposes.
      - Core.cpp: Generic important functions such as initialization.
      - Structures.cpp: Initialize data structures.
      - Version.cpp: Versioning and debug information.
    -->
    <file name="common/Core.cpp" />
    <file name="common/Structures.cpp" />
    <file name="common/Version.cpp" />

    <!-- NOTE: This one can't build without linking the shared library? -->
    <!--<file name="common/Format.cpp" />-->
  </files>

  <!-- The target NDLL file. -->
  <target id="NDLL" output="${LIBPREFIX}extension-ffmpeg${DEBUGEXTRA}${LIBSUFFIX}" tool="linker" toolid="${STD_MODULE_LINK}">
    <outdir name="${OUTPUT_DIR}/${BINDIR}" />

    <lib name="avcodec.lib" />
    <lib name="avformat.lib" />
    <lib name="avutil.lib" />

    <files id="core" />

    <flag value="-libpath:${LIBFFMPEG_BUILD}" if="windows" />
    
    <ext value=".so" />
    <ext value=".ndll" if="windows || mac || linux" />

    <lib name="Advapi32.lib" if="windows"/>
    <lib name="bcrypt.lib" if="windows"/>
    <lib name="Ws2_32.lib" if="windows"/>
    <lib name="-lpthread" if="linux" />
  </target>

  <!-- Redirect to the NDLL target if unspecified. -->
  <target id="default">
    <target id="NDLL" />
  </target>

</xml>